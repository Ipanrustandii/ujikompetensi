<?php
require '../config.php';
if (!is_logged()) { header('Location: ../index.php'); exit; }

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['checkout'])) {
    // data dari form: arrays produk_id[], qty[]
    $produk_ids = $_POST['produk_id'] ?? [];
    $qtys = $_POST['qty'] ?? [];
    $payment = $_POST['payment_method'] ?? 'cash';
    $paid_amount = floatval($_POST['paid_amount'] ?? 0);

    // Hitung total
    $total = 0;
    $items = [];
    foreach ($produk_ids as $i => $pid) {
        $pid = (int)$pid; $q = (int)$qtys[$i];
        if ($q <= 0) continue;
        $p = $pdo->prepare("SELECT * FROM produk WHERE id_produk = ? LIMIT 1");
        $p->execute([$pid]); $row = $p->fetch();
        if (!$row) continue;
        $subtotal = $row['harga'] * $q;
        $items[] = ['id'=>$pid,'qty'=>$q,'price'=>$row['harga'],'subtotal'=>$subtotal];
        $total += $subtotal;
    }

    // Insert transaksi header
    $stmt = $pdo->prepare("INSERT INTO transaksi (user_id,total,payment_method,paid_amount,change_amount,status) VALUES (?,?,?,?,?,?)");
    $change = $paid_amount - $total;
    $status = 'paid';
    $stmt->execute([$_SESSION['user']['user_id'],$total,$payment,$paid_amount, max(0,$change), $status]);
    $trans_id = $pdo->lastInsertId();

    // Insert details & update stock
    $ins = $pdo->prepare("INSERT INTO transaksi_detail (id_transaksi,id_produk,quantity,price,subtotal) VALUES (?,?,?,?,?)");
    $upd = $pdo->prepare("UPDATE produk SET stock = stock - ? WHERE id_produk = ?");
    foreach($items as $it) {
        $ins->execute([$trans_id,$it['id'],$it['qty'],$it['price'],$it['subtotal']]);
        $upd->execute([$it['qty'],$it['id']]);
    }

    header("Location: transaksi.php?success=1&id=".$trans_id);
    exit;
}

// ambil produk untuk dipilih
$produk = $pdo->query("SELECT * FROM produk WHERE stock > 0 ORDER BY nama_produk")->fetchAll();
?>
<!doctype html><html><head><meta charset="utf-8"><title>Transaksi</title><link rel="stylesheet" href="../../../theme.css" /></head><body>
<h2>Transaksi Baru</h2>
<?php if(isset($_GET['success'])) echo "<p style='color:green'>Transaksi berhasil. ID: ".htmlspecialchars($_GET['id'])."</p>"; ?>
<form method="post" id="trans">
  <table border=1>
    <tr><th>Pilih</th><th>Nama</th><th>Harga</th><th>Stock</th><th>Qty</th></tr>
    <?php foreach($produk as $p): ?>
    <tr>
      <td><input type="checkbox" class="chk" data-id="<?=$p['id_produk']?>" data-price="<?=$p['harga']?>"></td>
      <td><?=htmlspecialchars($p['nama_produk'])?></td>
      <td><?=$p['harga']?></td>
      <td><?=$p['stock']?></td>
      <td><input type="number" name="qty[]" value="1" min="1" data-id="<?=$p['id_produk']?>"></td>
      <input type="hidden" name="produk_id[]" value="<?=$p['id_produk']?>">
    </tr>
    <?php endforeach; ?>
  </table>

  <p>Metode pembayaran:
    <select name="payment_method">
      <option value="cash">Cash</option>
      <option value="qris">QRIS</option>
      <option value="card">Card</option>
    </select>
  </p>
  <p>Jumlah dibayar: <input name="paid_amount" type="number" step="0.01" required></p>

  <button name="checkout">Checkout</button>
</form>

<p><a href="index.php">Kembali</a></p>
</body></html>
